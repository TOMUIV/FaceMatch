<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶äººè„¸è¯†åˆ«ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            text-align: center;
            border-bottom: 1px solid #333;
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            color: #4fc3f7;
        }
        
        .header .subtitle {
            font-size: 1em;
            opacity: 0.8;
        }
        
        .performance-info {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .video-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: #000;
        }
        
        .video-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #videoElement {
            display: none;
        }
        
        #canvasElement {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }
        
        .controls-panel {
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            border-top: 1px solid #333;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .stats-panel {
            display: none; /* éšè—çŠ¶æ€æ  */
        }
        
        .stats-panel h2 {
            margin-bottom: 15px;
            text-align: center;
            color: #4fc3f7;
            font-size: 1.4em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-item.highlight {
            background: rgba(79, 195, 247, 0.2);
            transform: scale(1.05);
        }
        
        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            margin: 5px 0;
            color: #4fc3f7;
        }
        
        .stat-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            background: #2196f3;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        button:hover {
            background: #1976d2;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        button.stop {
            background: #f44336;
        }
        
        button.stop:hover {
            background: #d32f2f;
        }
        
        button.success {
            background: #4caf50;
        }
        
        button.success:hover {
            background: #388e3c;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f44336;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #4caf50;
        }
        
        .status-dot.camera-active {
            background: #ff9800;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .logs-section {
            background: #0a0a0a;
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            flex: 1;
        }
        
        .log-entry {
            margin-bottom: 4px;
        }
        
        .log-timestamp {
            color: #666;
            margin-right: 8px;
        }
        
        .resolution-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #ccc;
        }
        
        .fps-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #ccc;
        }
        
        .latency-info {
            position: absolute;
            top: 40px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #ccc;
        }
        
        .camera-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        select {
            padding: 8px 12px;
            border-radius: 6px;
            background: #333;
            color: white;
            border: 1px solid #555;
            font-size: 14px;
            min-width: 150px;
        }
        
        .quality-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .quality-slider {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quality-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        input[type="range"] {
            width: 100px;
        }
        
        .optimization-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(76, 175, 80, 0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7em;
        }
        
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            
            .stats-panel {
                width: 100%;
                max-height: 300px;
                border-left: none;
                border-top: 1px solid #333;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            button {
                width: 100%;
            }
            
            .camera-selector, .quality-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            select, input[type="range"] {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” å®æ—¶äººè„¸è¯†åˆ«ç³»ç»Ÿ</h1>
        <div class="subtitle">åŸºäºæ·±åº¦å­¦ä¹ çš„äººè„¸è¯†åˆ«æŠ€æœ¯</div>
        <div class="performance-info">å»¶è¿Ÿä¼˜åŒ–ç‰ˆ | WebSocketå®æ—¶é€šä¿¡</div>
    </div>
    
    <div class="main-container">
        <div class="video-section">
            <div class="video-container">
                <video id="videoElement" autoplay playsinline></video>
                <canvas id="canvasElement"></canvas>
                <div class="fps-counter" id="fpsCounter">FPS: 0</div>
                <div class="latency-info" id="latencyInfo">å»¶è¿Ÿ: 0ms</div>
                <div class="resolution-info" id="resolutionInfo">åˆ†è¾¨ç‡: æœªå¯åŠ¨</div>

            </div>
            
            <div class="controls-panel">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">ç­‰å¾…è¿æ¥...</span>
                </div>
                
                <button onclick="startCamera()" id="startBtn">
                    ğŸ“¹ å¯åŠ¨æ‘„åƒå¤´
                </button>
                <button onclick="stopCamera()" id="stopBtn" disabled class="stop">
                    â¹ åœæ­¢æ‘„åƒå¤´
                </button>
                
                <div class="camera-selector" id="cameraSelector" style="display: none;">
                    <label for="cameraSelect">æ‘„åƒå¤´:</label>
                    <select id="cameraSelect" onchange="switchCamera()"></select>
                </div>
                
                <button onclick="takeScreenshot()" id="screenshotBtn" disabled class="success">
                    ğŸ“¸ æˆªå›¾
                </button>
                

                
                <button onclick="toggleLogs()" id="logsBtn">
                    ğŸ“‹ æ—¥å¿—
                </button>
            </div>
        </div>
        
        <div class="stats-panel">
            <h2>ğŸ“Š è¯†åˆ«ç»Ÿè®¡</h2>
            <div class="stats-grid">
                <div class="stat-item" id="statTotalFrames">
                    <div class="stat-label">å¤„ç†å¸§æ•°</div>
                    <div class="stat-value" id="totalFrames">0</div>
                </div>
                <div class="stat-item" id="statTotalFaces">
                    <div class="stat-label">æ£€æµ‹äººè„¸</div>
                    <div class="stat-value" id="totalFaces">0</div>
                </div>
                <div class="stat-item" id="statRecognizedFaces">
                    <div class="stat-label">è¯†åˆ«æˆåŠŸ</div>
                    <div class="stat-value" id="recognizedFaces">0</div>
                </div>
                <div class="stat-item" id="statUnknownFaces">
                    <div class="stat-label">æœªçŸ¥äººè„¸</div>
                    <div class="stat-value" id="unknownFaces">0</div>
                </div>
                <div class="stat-item" id="statFPS">
                    <div class="stat-label">FPS</div>
                    <div class="stat-value" id="fps">0</div>
                </div>
                <div class="stat-item" id="statLatency">
                    <div class="stat-label">å¹³å‡å»¶è¿Ÿ</div>
                    <div class="stat-value" id="avgLatency">0ms</div>
                </div>
                <div class="stat-item" id="statActiveClients">
                    <div class="stat-label">æ´»è·ƒå®¢æˆ·ç«¯</div>
                    <div class="stat-value" id="activeClients">0</div>
                </div>
                <div class="stat-item" id="statConnectionStatus">
                    <div class="stat-label">è¿æ¥çŠ¶æ€</div>
                    <div class="stat-value" id="connectionStatus">ç¦»çº¿</div>
                </div>
            </div>
            
            <h3 style="margin: 15px 0 10px 0;">ç³»ç»Ÿæ—¥å¿—</h3>
            <div class="logs-section" id="logsContainer">
                <div id="logContent"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let socket = null;
        let videoStream = null;
        let isProcessing = false;
        let animationFrameId = null;
        let statsInterval = null;
        let frameCount = 0;
        let lastFrameTime = 0;
        let currentFPS = 0;
        let isWebSocketConnected = false;
        let isCameraActive = false;
        let lastRecognitionResults = [];
        let frameCounter = 0;
        let availableCameras = [];
        let currentCameraId = null;
        let latencyMeasurements = [];
        let lastOptimizationUpdate = 0;
        
        // å›ºå®šé…ç½® - å¹³è¡¡é€Ÿåº¦å’Œè¯†åˆ«ç‡
        const CONFIG = {
            sendInterval: 3, // æ¯3å¸§å‘é€ä¸€æ¬¡
            imageQuality: 0.5, // å›¾åƒè´¨é‡ï¼ˆæé«˜ä»¥æ”¹å–„è¯†åˆ«ï¼‰
            maxWidth: 640,  // åˆ†è¾¨ç‡
            maxHeight: 480
        };
        
        // å»¶è¿Ÿç»Ÿè®¡
        const latencyStats = {
            total: 0,
            count: 0,
            min: Infinity,
            max: 0,
            get average() {
                return this.count > 0 ? Math.round(this.total / this.count) : 0;
            }
        };
        
        // DOMå…ƒç´ 
        const videoElement = document.getElementById('videoElement');
        const canvasElement = document.getElementById('canvasElement');
        const canvasContext = canvasElement.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const screenshotBtn = document.getElementById('screenshotBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const fpsCounter = document.getElementById('fpsCounter');
        const latencyInfo = document.getElementById('latencyInfo');
        const resolutionInfo = document.getElementById('resolutionInfo');
        const cameraSelector = document.getElementById('cameraSelector');
        const cameraSelect = document.getElementById('cameraSelect');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            checkBrowserCompatibility();
            enumerateCameras();
            statsInterval = setInterval(updateStats, 2000);
            
            // é¡µé¢å…³é—­æ—¶æ¸…ç†èµ„æº
            window.addEventListener('beforeunload', cleanup);
        });
        
        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        function checkBrowserCompatibility() {
            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            
            if (!hasGetUserMedia) {
                const legacyGetUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || 
                                          navigator.mozGetUserMedia || navigator.msGetUserMedia;
                
                if (legacyGetUserMedia) {
                    navigator.mediaDevices = navigator.mediaDevices || {};
                    navigator.mediaDevices.getUserMedia = function(constraints) {
                        return new Promise(function(resolve, reject) {
                            legacyGetUserMedia.call(navigator, constraints, resolve, reject);
                        });
                    };
                }
            }
        }
        
        // æšä¸¾å¯ç”¨æ‘„åƒå¤´
        async function enumerateCameras() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                    addLog('è­¦å‘Š: æµè§ˆå™¨ä¸æ”¯æŒæšä¸¾è®¾å¤‡');
                    return;
                }
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                
                // æ›´æ–°æ‘„åƒå¤´é€‰æ‹©å™¨
                updateCameraSelector();
                
                if (availableCameras.length === 0) {
                    addLog('æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡');
                } else {
                    addLog(`æ‰¾åˆ° ${availableCameras.length} ä¸ªæ‘„åƒå¤´è®¾å¤‡`);
                    
                    // å¦‚æœæœ‰å¤šä¸ªæ‘„åƒå¤´ï¼Œæ˜¾ç¤ºé€‰æ‹©å™¨
                    if (availableCameras.length > 1) {
                        cameraSelector.style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error('æšä¸¾æ‘„åƒå¤´å¤±è´¥:', error);
                addLog(`æšä¸¾æ‘„åƒå¤´å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ›´æ–°æ‘„åƒå¤´é€‰æ‹©å™¨
        function updateCameraSelector() {
            cameraSelect.innerHTML = '';
            
            availableCameras.forEach((camera, index) => {
                const option = document.createElement('option');
                option.value = camera.deviceId;
                option.textContent = camera.label || `æ‘„åƒå¤´ ${index + 1}`;
                cameraSelect.appendChild(option);
            });
            
            // å¦‚æœæœ‰æ‘„åƒå¤´ï¼Œè®¾ç½®é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
            if (availableCameras.length > 0) {
                currentCameraId = availableCameras[0].deviceId;
            }
        }
        

        
        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initializeSocket() {
            console.log('[WebSocket] å¼€å§‹åˆå§‹åŒ–è¿æ¥...');
            
            // é…ç½®Socket.IOè¿æ¥é€‰é¡¹
            socket = io({
                transports: ['websocket', 'polling'],  // ä¼˜å…ˆä½¿ç”¨WebSocketï¼Œå›é€€åˆ°è½®è¯¢
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            socket.on('connect', function() {
                console.log('[WebSocket] è¿æ¥æˆåŠŸ, ID:', socket.id);
                isWebSocketConnected = true;
                updateStatus('æœåŠ¡å™¨è¿æ¥æˆåŠŸ', 'connected');
                addLog('WebSocketè¿æ¥å·²å»ºç«‹, ID: ' + socket.id);
            });
            
            socket.on('connect_error', function(error) {
                console.error('[WebSocket] è¿æ¥é”™è¯¯:', error);
                addLog(`WebSocketè¿æ¥é”™è¯¯: ${error.message || error}`);
            });
            
            socket.on('reconnect', function(attemptNumber) {
                console.log('[WebSocket] é‡æ–°è¿æ¥æˆåŠŸ, å°è¯•æ¬¡æ•°:', attemptNumber);
                addLog(`WebSocketé‡æ–°è¿æ¥æˆåŠŸ (å°è¯• ${attemptNumber})`);
            });
            
            socket.on('reconnect_error', function(error) {
                console.error('[WebSocket] é‡æ–°è¿æ¥é”™è¯¯:', error);
            });
            
            socket.on('disconnect', function() {
                isWebSocketConnected = false;
                updateStatus('æœåŠ¡å™¨è¿æ¥å·²æ–­å¼€', 'disconnected');
                addLog('WebSocketè¿æ¥å·²æ–­å¼€');
                
                if (isCameraActive) {
                    updateStatus('æ‘„åƒå¤´å·²å¯åŠ¨ (æœåŠ¡å™¨æ–­å¼€)', 'camera-active');
                }
            });
            
            socket.on('connected', function(data) {
                addLog(`æœåŠ¡å™¨è¿æ¥ç¡®è®¤: ${data.message}`);
            });
            
            socket.on('recognition_result', function(data) {
                // è®¡ç®—å»¶è¿Ÿï¼ˆä½¿ç”¨å®¢æˆ·ç«¯å‘é€çš„æ—¶é—´æˆ³ï¼‰
                const clientTimestamp = data.client_timestamp || 0;
                let latency = 0;
                
                if (clientTimestamp > 0) {
                    latency = Date.now() - clientTimestamp;
                }
                
                // ç¡®ä¿å»¶è¿Ÿä¸ä¸ºè´Ÿæ•°
                latency = Math.max(0, latency);
                
                // æ›´æ–°å»¶è¿Ÿç»Ÿè®¡
                updateLatencyStats(latency);
                
                // ä¿å­˜è¯†åˆ«ç»“æœï¼Œå°†åœ¨ç»˜åˆ¶æ—¶ä½¿ç”¨
                lastRecognitionResults = data.results || [];
            });
            
            socket.on('error', function(data) {
                addLog(`æœåŠ¡å™¨é”™è¯¯: ${data.message}`);
                console.error('æœåŠ¡å™¨é”™è¯¯:', data);
            });
            
            socket.on('screenshot_saved', function(data) {
                addLog(`æˆªå›¾å·²ä¿å­˜: ${data.filename || data.path}`);
                console.log('æˆªå›¾ä¿¡æ¯:', data);
            });
            
            socket.on('screenshot_error', function(data) {
                addLog(`æˆªå›¾å¤±è´¥: ${data.message}`);
            });
        }
        
        // æ›´æ–°å»¶è¿Ÿç»Ÿè®¡
        function updateLatencyStats(latency) {
            latencyStats.total += latency;
            latencyStats.count++;
            latencyStats.min = Math.min(latencyStats.min, latency);
            latencyStats.max = Math.max(latencyStats.max, latency);
            
            // æ›´æ–°æ˜¾ç¤º
            latencyInfo.textContent = `å»¶è¿Ÿ: ${latency}ms (å¹³å‡: ${latencyStats.average}ms)`;
        }
        
        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                addLog('æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...');
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    addLog('é”™è¯¯: æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®');
                    updateStatus('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´', 'error');
                    return;
                }
                
                // å¦‚æœæ²¡æœ‰æ‘„åƒå¤´è®¾å¤‡ï¼Œå°è¯•é‡æ–°æšä¸¾
                if (availableCameras.length === 0) {
                    await enumerateCameras();
                    
                    if (availableCameras.length === 0) {
                        addLog('é”™è¯¯: æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡');
                        updateStatus('æœªæ‰¾åˆ°æ‘„åƒå¤´', 'error');
                        return;
                    }
                }
                
                // è·å–é€‰å®šçš„æ‘„åƒå¤´ID
                const selectedCameraId = cameraSelect.value || currentCameraId;
                
                // ä½¿ç”¨å›ºå®šåˆ†è¾¨ç‡
                const maxWidth = CONFIG.maxWidth;
                const maxHeight = CONFIG.maxHeight;
                
                // å°è¯•è·å–åˆé€‚çš„åˆ†è¾¨ç‡
                const constraints = {
                    video: {
                        deviceId: selectedCameraId ? { exact: selectedCameraId } : undefined,
                        width: { ideal: maxWidth },
                        height: { ideal: maxHeight },
                        frameRate: { ideal: 30 },
                        aspectRatio: { ideal: 16/9 }
                    },
                    audio: false
                };
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = videoStream;
                
                // ç­‰å¾…è§†é¢‘åŠ è½½
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = resolve;
                });
                
                // è·å–å®é™…åˆ†è¾¨ç‡
                const actualWidth = videoElement.videoWidth;
                const actualHeight = videoElement.videoHeight;
                
                // è®¾ç½®Canvasä¸ºæ‘„åƒå¤´åŸå§‹åˆ†è¾¨ç‡
                canvasElement.width = actualWidth;
                canvasElement.height = actualHeight;
                
                // æ›´æ–°åˆ†è¾¨ç‡ä¿¡æ¯
                resolutionInfo.textContent = `åˆ†è¾¨ç‡: ${actualWidth}Ã—${actualHeight}`;
                
                // å¼€å§‹å¤„ç†å¸§
                isProcessing = true;
                isCameraActive = true;
                
                // ä½¿ç”¨requestAnimationFrameå®ç°æµç•…æ¸²æŸ“
                function processFrame() {
                    if (!isProcessing || !videoStream) return;
                    
                    try {
                        // ç»˜åˆ¶å½“å‰è§†é¢‘å¸§åˆ°Canvas
                        canvasContext.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                        
                        // ç»˜åˆ¶äººè„¸è¯†åˆ«æ¡†ï¼ˆä½¿ç”¨ä¸Šä¸€æ¬¡çš„ç»“æœï¼Œé¿å…é—ªçƒï¼‰
                        drawRecognitionResults(lastRecognitionResults);
                        
                        // è®¡ç®—FPS
                        const now = performance.now();
                        if (lastFrameTime > 0) {
                            const delta = now - lastFrameTime;
                            currentFPS = Math.round(1000 / delta);
                            fpsCounter.textContent = `FPS: ${currentFPS}`;
                        }
                        lastFrameTime = now;
                        frameCount++;
                        
                        // å‘é€å¸§åˆ°æœåŠ¡å™¨ - å›ºå®šé—´éš”
                        frameCounter++;
                        if (frameCounter % CONFIG.sendInterval === 0 && isWebSocketConnected) {
                            const imageData = canvasElement.toDataURL('image/jpeg', CONFIG.imageQuality);
                            socket.emit('frame', { 
                                image_data: imageData,
                                timestamp: Date.now()
                            });
                        }
                        
                        // ç»§ç»­ä¸‹ä¸€å¸§
                        animationFrameId = requestAnimationFrame(processFrame);
                        
                    } catch (error) {
                        console.error('å¤„ç†å¸§å¤±è´¥:', error);
                    }
                }
                
                // å¯åŠ¨æ¸²æŸ“å¾ªç¯
                animationFrameId = requestAnimationFrame(processFrame);
                
                // æ›´æ–°UIçŠ¶æ€
                startBtn.disabled = true;
                stopBtn.disabled = false;
                screenshotBtn.disabled = false;
                
                updateStatus('æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œæ­£åœ¨è¯†åˆ«...', 'camera-active');
                
                // è·å–æ‘„åƒå¤´åç§°ç”¨äºæ—¥å¿—
                const selectedCamera = availableCameras.find(cam => cam.deviceId === selectedCameraId);
                const cameraName = selectedCamera ? (selectedCamera.label || 'æœªçŸ¥æ‘„åƒå¤´') : 'æœªçŸ¥æ‘„åƒå¤´';
                
                addLog(`æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ: ${cameraName}, åˆ†è¾¨ç‡: ${actualWidth}Ã—${actualHeight}`);
                
            } catch (error) {
                console.error('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:', error);
                addLog(`æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ${error.message}`);
                
                if (error.name === 'NotAllowedError') {
                    addLog('æ‘„åƒå¤´è®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
                } else if (error.name === 'NotFoundError') {
                    addLog('æœªæ‰¾åˆ°å¯ç”¨çš„æ‘„åƒå¤´è®¾å¤‡');
                } else if (error.name === 'NotSupportedError') {
                    addLog('å½“å‰ç¯å¢ƒä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½');
                } else if (error.name === 'NotReadableError') {
                    addLog('æ‘„åƒå¤´è®¾å¤‡æ­£è¢«å…¶ä»–åº”ç”¨å ç”¨');
                } else if (error.name === 'OverconstrainedError') {
                    addLog('æ— æ³•æ»¡è¶³æ‘„åƒå¤´çº¦æŸæ¡ä»¶ï¼Œå°è¯•åˆ‡æ¢æ‘„åƒå¤´');
                    // å°è¯•åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ‘„åƒå¤´
                    switchToNextCamera();
                }
                
                updateStatus('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥', 'error');
            }
        }
        

        
        // åœæ­¢æ‘„åƒå¤´
        function stopCamera() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            isProcessing = false;
            isCameraActive = false;
            
            // æ¸…é™¤Canvas
            canvasContext.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // æ›´æ–°UIçŠ¶æ€
            startBtn.disabled = false;
            stopBtn.disabled = true;
            screenshotBtn.disabled = true;
            
            // æ›´æ–°çŠ¶æ€
            if (isWebSocketConnected) {
                updateStatus('æ‘„åƒå¤´å·²åœæ­¢', 'connected');
            } else {
                updateStatus('æ‘„åƒå¤´å·²åœæ­¢', 'disconnected');
            }
            
            // é‡ç½®ä¿¡æ¯æ˜¾ç¤º
            fpsCounter.textContent = 'FPS: 0';
            latencyInfo.textContent = 'å»¶è¿Ÿ: 0ms';
            resolutionInfo.textContent = 'åˆ†è¾¨ç‡: æœªå¯åŠ¨';
            
            addLog('æ‘„åƒå¤´å·²åœæ­¢');
        }
        
        // åˆ‡æ¢æ‘„åƒå¤´
        async function switchCamera() {
            if (!isCameraActive) {
                return; // å¦‚æœæ‘„åƒå¤´æœªå¯åŠ¨ï¼Œä¸æ‰§è¡Œåˆ‡æ¢
            }
            
            const selectedCameraId = cameraSelect.value;
            
            if (selectedCameraId === currentCameraId) {
                return; // å¦‚æœé€‰æ‹©çš„æ‘„åƒå¤´å·²ç»æ˜¯å½“å‰æ‘„åƒå¤´ï¼Œä¸æ‰§è¡Œåˆ‡æ¢
            }
            
            addLog(`æ­£åœ¨åˆ‡æ¢åˆ°æ‘„åƒå¤´: ${cameraSelect.options[cameraSelect.selectedIndex].text}`);
            
            // ä¿å­˜å½“å‰çŠ¶æ€
            const wasProcessing = isProcessing;
            
            // åœæ­¢å½“å‰æ‘„åƒå¤´
            stopCamera();
            
            // è®¾ç½®æ–°çš„æ‘„åƒå¤´ID
            currentCameraId = selectedCameraId;
            
            // é‡æ–°å¯åŠ¨æ‘„åƒå¤´
            if (wasProcessing) {
                setTimeout(startCamera, 100); // ç¨ç­‰ç‰‡åˆ»å†å¯åŠ¨
            }
        }
        
        // ç»˜åˆ¶è¯†åˆ«ç»“æœ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œé¿å…é—ªçƒ
        function drawRecognitionResults(results) {
            if (!results || results.length === 0) return;
            
            // ä¿å­˜å½“å‰CanvasçŠ¶æ€
            canvasContext.save();
            
            results.forEach(result => {
                const [x1, y1, x2, y2] = result.bbox;
                const personName = result.person_name;
                const similarity = result.similarity;
                const confidence = result.confidence;
                
                // ç¡®å®šé¢œè‰²
                const isKnown = personName !== "æœªçŸ¥";
                const boxColor = isKnown ? '#00ff00' : '#ff0000';
                const textColor = '#ffffff';
                
                // ç»˜åˆ¶äººè„¸æ¡† - ä½¿ç”¨æ›´ç²—çš„çº¿æ¡
                canvasContext.strokeStyle = boxColor;
                canvasContext.lineWidth = 3;
                canvasContext.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                // ç»˜åˆ¶æ–‡æœ¬èƒŒæ™¯
                const nameText = isKnown ? personName : 'æœªçŸ¥';
                canvasContext.font = 'bold 18px Microsoft YaHei, Arial, sans-serif';
                const nameTextWidth = canvasContext.measureText(nameText).width;
                
                // æ–‡æœ¬èƒŒæ™¯
                canvasContext.fillStyle = 'rgba(0, 0, 0, 0.7)';
                canvasContext.fillRect(x1 - 2, y1 - 25, nameTextWidth + 10, 25);
                
                // ç»˜åˆ¶å§“åæ–‡æœ¬
                canvasContext.fillStyle = textColor;
                canvasContext.fillText(nameText, x1 + 3, y1 - 7);
                
                // ç»˜åˆ¶ç›¸ä¼¼åº¦ï¼ˆå¦‚æœå·²çŸ¥ï¼‰
                if (isKnown) {
                    const similarityText = `ç›¸ä¼¼åº¦: ${(similarity * 100).toFixed(1)}%`;
                    const similarityWidth = canvasContext.measureText(similarityText).width;
                    
                    canvasContext.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    canvasContext.fillRect(x1 - 2, y2, similarityWidth + 10, 20);
                    
                    canvasContext.fillStyle = textColor;
                    canvasContext.fillText(similarityText, x1 + 3, y2 + 15);
                }
                
                // ç»˜åˆ¶ç½®ä¿¡åº¦
                const confidenceText = `ç½®ä¿¡åº¦: ${(confidence * 100).toFixed(1)}%`;
                const confidenceWidth = canvasContext.measureText(confidenceText).width;
                
                canvasContext.fillStyle = 'rgba(0, 0, 0, 0.7)';
                canvasContext.fillRect(x1 - 2, y2 + 20, confidenceWidth + 10, 20);
                
                canvasContext.fillStyle = textColor;
                canvasContext.fillText(confidenceText, x1 + 3, y2 + 35);
            });
            
            // æ¢å¤CanvasçŠ¶æ€
            canvasContext.restore();
        }
        
        // æˆªå›¾åŠŸèƒ½
        function takeScreenshot() {
            if (!videoStream) {
                addLog('é”™è¯¯: æ‘„åƒå¤´æœªå¯åŠ¨');
                return;
            }
            
            try {
                const imageData = canvasElement.toDataURL('image/jpeg', 1.0); // æœ€é«˜è´¨é‡
                socket.emit('screenshot', { image_data: imageData });
                addLog('æ­£åœ¨ä¿å­˜æˆªå›¾...');
            } catch (error) {
                console.error('æˆªå›¾å¤±è´¥:', error);
                addLog(`æˆªå›¾å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, status) {
            statusText.textContent = message;
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            statusDot.classList.remove('connected', 'camera-active', 'disconnected');
            
            // æ·»åŠ å½“å‰çŠ¶æ€ç±»
            if (status === 'connected') {
                statusDot.classList.add('connected');
            } else if (status === 'camera-active') {
                statusDot.classList.add('camera-active');
            } else {
                statusDot.classList.add('disconnected');
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function updateStats() {
            try {
                const response = await fetch('/stats');
                const stats = await response.json();
                
                if (stats.error) {
                    console.error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', stats.error);
                    return;
                }
                
                // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                document.getElementById('totalFrames').textContent = stats.total_frames.toLocaleString();
                document.getElementById('totalFaces').textContent = stats.total_faces.toLocaleString();
                document.getElementById('recognizedFaces').textContent = stats.recognized_faces.toLocaleString();
                document.getElementById('unknownFaces').textContent = stats.unknown_faces.toLocaleString();
                document.getElementById('fps').textContent = stats.fps ? stats.fps.toFixed(1) : '0';
                document.getElementById('avgLatency').textContent = latencyStats.average + 'ms';
                document.getElementById('activeClients').textContent = stats.active_clients.toLocaleString();
                document.getElementById('connectionStatus').textContent = isWebSocketConnected ? 'åœ¨çº¿' : 'ç¦»çº¿';
                
                // é«˜äº®å»¶è¿Ÿç»Ÿè®¡
                const latencyStat = document.getElementById('statLatency');
                latencyStat.classList.toggle('highlight', latencyStats.average > 300);
                
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span>${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // æ˜¾ç¤º/éšè—æ—¥å¿—
        function toggleLogs() {
            const logsContainer = document.getElementById('logsContainer');
            if (logsContainer.style.display === 'none') {
                logsContainer.style.display = 'block';
                document.getElementById('logsBtn').textContent = 'ğŸ“‹ éšè—æ—¥å¿—';
            } else {
                logsContainer.style.display = 'none';
                document.getElementById('logsBtn').textContent = 'ğŸ“‹ æ˜¾ç¤ºæ—¥å¿—';
            }
        }
        
        // æ¸…ç†èµ„æº
        function cleanup() {
            stopCamera();
            if (statsInterval) {
                clearInterval(statsInterval);
            }
            if (socket) {
                socket.disconnect();
            }
        }
    </script>
</body>
</html>